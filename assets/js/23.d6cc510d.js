(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{530:function(s,t,a){"use strict";a.r(t);var n=a(6),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"背景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[s._v("#")]),s._v(" 背景")]),s._v(" "),a("ul",[a("li",[s._v("服务器上CPU使用率已跑满，且top执行无反应，无法找到CPU占用率高的进程")])]),s._v(" "),a("h2",{attrs:{id:"_1-top命令失效原因"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-top命令失效原因"}},[s._v("#")]),s._v(" 1.top命令失效原因")]),s._v(" "),a("p",[s._v("普通的top命令根本无法显示木马进程，看起来像是很正常的样子，因为top命令很可能已经被入侵者修改")]),s._v(" "),a("p",[s._v("运行 busybox top可以看到隐藏的占用CPU的进程，原始的top已经被修改，不能显示病毒的进程，必须在busybox中执行")]),s._v(" "),a("p",[s._v("下载腾讯云给的排查工具busybox：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@VM-8-8-centos ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wget https://tao-1257166515.cos.ap-chengdu.myqcloud.com/busybox")]),s._v("\n--2020-12-14 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":12:59--  https://tao-1257166515.cos.ap-chengdu.myqcloud.com/busybox\nResolving tao-1257166515.cos.ap-chengdu.myqcloud.com "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tao-1257166515.cos.ap-chengdu.myqcloud.com"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("132.232")]),s._v(".176.6, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("132.232")]),s._v(".176.7, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("139.155")]),s._v(".60.205, "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nConnecting to tao-1257166515.cos.ap-chengdu.myqcloud.com "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tao-1257166515.cos.ap-chengdu.myqcloud.com"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("132.232")]),s._v(".176.6"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(":443"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". connected.\nHTTP request sent, awaiting response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" OK\nLength: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001112")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("978K"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("application/octet-stream"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nSaving to: ‘busybox.1’\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("%"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1,001")]),s._v(",112   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".36MB/s   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(".7s\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@VM-8-8-centos ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp busybox /usr/bin/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@VM-8-8-centos ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# busybox top")]),s._v("\n-bash: /usr/bin/busybox: Permission denied\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@VM-8-8-centos ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /usr/bin/")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@VM-8-8-centos bin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chmod 777 /usr/bin/busybox")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@VM-8-8-centos ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# busybox top")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("ul",[a("li",[s._v("除了top命令外，可能系统很多关键命令都被篡改了，如:\n"),a("ul",[a("li",[s._v("kill掉某个存在pid显示 没有该进程，很有可能是kill命令也被修改了")]),s._v(" "),a("li",[s._v("ll ls 等命令看不到某些文件，也是被修改了")]),s._v(" "),a("li",[s._v("rm 命令也无法删除木马文件，可能也被修改了")])])])]),s._v(" "),a("h2",{attrs:{id:"_2-预加载型动态链接库后门"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-预加载型动态链接库后门"}},[s._v("#")]),s._v(" 2. 预加载型动态链接库后门")]),s._v(" "),a("p",[s._v("linux操作系统的动态链接库在加载过程中，动态链接器会先读取LD_PRELOAD环境变量和默认配置文件/etc/ld.so.preload，并将读取到的动态链接库文件进行预加载，即使程序不依赖这些动态链接库，LD_PRELOAD环境变量和/etc/ld.so.preload配置文件中指定的动态链接库依然会被装载,因为它们的优先级比LD_LIBRARY_PATH环境变量所定义的链接库查找路径的文件优先级要高，所以能够提前于用户调用的动态库载入。这就是为什么在watchdogs挖矿木马中使用top、ps等命令无法发现挖矿进程的原因，这种后门推荐使用静态编译的ls、ps等命令或者busybox进行查找。")]),s._v(" "),a("h3",{attrs:{id:"利用ld-preload"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#利用ld-preload"}},[s._v("#")]),s._v(" 利用LD_PRELOAD")]),s._v(" "),a("p",[s._v("检测:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("echo $LD_PRELOAD\n#默认无输出，如果有输出就需要去看下文件是否为异常文件了\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("清除:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("unset LD_PRELOAD\n#使用命令unset LD_PRELOAD即可卸载使用LD_PRELOAD环境变量安装的恶意动态链接库\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"利用-etc-ld-so-preload"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#利用-etc-ld-so-preload"}},[s._v("#")]),s._v(" 利用/etc/ld.so.preload")]),s._v(" "),a("p",[s._v("检测")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("1、文件完整性检测\n修改了默认的动态链接库后文件完整性发生变化，可以使用rpm等来校验\n首先获取系统中的动态链接器的文件路径(interp段指定了动态链接器的位置)\nreadelf -a /bin/ps | grep interpreter\n然后判断该动态链接器文件的完整性\nbusybox ls -al /usr/local/lib/libioset.so\nrpm -Vf /usr/local/lib/libioset.so\n2、使用strace\nstrace可以跟踪一个进程执行时所产生的系统调用，包括参数，返回值，执行消耗的时间和所接收的信号\nstrace -f -e trace=file /bin/ps\n-f 表示同时跟踪fork和vfork出来的进程\n-e trace=file 表示只跟踪有关文件操作的系统调用\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("清除")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("busybox rm -rf /etc/ld.so.preload\n清除调用的对应恶意文件即可\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);