(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{532:function(s,n,a){"use strict";a.r(n);var t=a(6),e=Object(t.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"_1-问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-问题"}},[s._v("#")]),s._v(" 1. 问题")]),s._v(" "),a("ul",[a("li",[s._v("Oracle数据库下,使用jdbc批量执行sql操作，出现java.sql.SQLException: 不允许的操作: operation cannot be mixed with Oracle-style batching")]),s._v(" "),a("li",[s._v("代码如下:")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('try (PreparedStatement ps = conn.prepareStatement("INSERT INTO students (name, gender, grade, score) VALUES (?, ?, ?, ?)")) {\n    // 对同一个PreparedStatement反复设置参数并调用addBatch():\n    for (Student s : students) {\n        ps.setString(1, s.name);\n        ps.setBoolean(2, s.gender);\n        ps.setInt(3, s.grade);\n        ps.setInt(4, s.score);\n        ps.addBatch(); // 添加到batch\n    }\n    // 执行batch:\n    int[] ns = ps.executeBatch();\n    for (int n : ns) {\n        // batch中每个SQL执行的结果数量\n        System.out.println(n + " inserted."); \n    }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("ul",[a("li",[s._v("如上，代码运行至addBatch方法时，便抛出异常")])]),s._v(" "),a("h2",{attrs:{id:"_2-原因"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-原因"}},[s._v("#")]),s._v(" 2. 原因")]),s._v(" "),a("ul",[a("li",[s._v("查看 OraclePreparedStatement.class 中 addBatch方法：")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('public void addBatch() throws SQLException {\n        synchronized(this.connection) {\n            this.setJdbcBatchStyle();\n            this.processCompletedBindRow(this.currentRank + 2, this.currentRank > 0 && this.sqlKind.isPlsqlOrCall());\n            ++this.currentRank;\n        }\n}\n\nfinal void setJdbcBatchStyle() throws SQLException {\n        if (this.m_batchStyle == 1) {\n            SQLException var1 = DatabaseError.createSqlException(this.getConnectionDuringExceptionHandling(), 90, "operation cannot be mixed with Oracle-style batching");\n            var1.fillInStackTrace();\n            throw var1;\n        } else {\n            this.m_batchStyle = 2;\n        }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("ul",[a("li",[s._v("addBatch 和 executeBatch 会校验批处理模式，只有在 JDBC标准模式下 才能够使用")]),s._v(" "),a("li",[s._v("由于 m_batchStyle 在问题代码中不知何原因属性为 1，也就是批量操作模式为Oracle，所以导致了报错。")])]),s._v(" "),a("h3",{attrs:{id:"_2-1-关于批量操作模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-关于批量操作模式"}},[s._v("#")]),s._v(" 2.1 关于批量操作模式")]),s._v(" "),a("ul",[a("li",[s._v("Oracle JDBC 支持两种不同的更新批处理模型：\n"),a("ul",[a("li",[s._v("标准模型，实现 JDBC 2.0 规范，称为标准更新批处理")]),s._v(" "),a("li",[s._v("Oracle 特定模型，独立于 JDBC 2.0 规范，称为 Oracle 更新批处理")])])]),s._v(" "),a("li",[s._v("需要注意的是，您不能混合使用这些模型。在任何单个应用程序中，您只能使用其中一种模型，但不能同时使用这两种模型。如果混合使用这些模型，Oracle JDBC 驱动程序将引发异常。")])]),s._v(" "),a("h2",{attrs:{id:"_4-异常解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-异常解决方案"}},[s._v("#")]),s._v(" 4. 异常解决方案")]),s._v(" "),a("ul",[a("li",[s._v("默认情况下，批量模式一般为 JDBC，那么为何在上诉代码中，会变成了Oracle模式呢？ 可能由以下原因造成的：\n"),a("ul",[a("li",[s._v("显示调用了 ((OracleConnection)conn).setDefaultExecuteBatch(..)方法，该方法会将模式设置为Oracle批处理模式")]),s._v(" "),a("li",[s._v("在连接上使用了连接属性defaultBatchValue或数据源中的类似属性,这将禁止 JDBC 标准批处理，并使用特定于 Oracle 驱动程序的某种内部批处理机制")])])]),s._v(" "),a("li",[s._v("那么就有以下两种解决方案\n"),a("ul",[a("li",[a("ol",[a("li",[s._v("使用与批处理模式一致的操作方法，即Oracle模式下，使用 sendBatch 方法")])])]),s._v(" "),a("li",[a("ol",{attrs:{start:"2"}},[a("li",[s._v("调整连接属性或去除显示或隐式设置了Orclae模式方法，使得批处理模式为 Jdbc标准模式")])])])])])]),s._v(" "),a("h2",{attrs:{id:"_5-扩展：两种批处理方法的区别"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-扩展：两种批处理方法的区别"}},[s._v("#")]),s._v(" 5. 扩展：两种批处理方法的区别")]),s._v(" "),a("ul",[a("li",[s._v("sendBatch()是 Oracle 版本的批处理。Oracle 表示，使用该版本更适合 Oracle，并且性能更高。Oracle 批处理仅支持PreparedStatement。")]),s._v(" "),a("li",[s._v("executeBatch()是 jdbc 标准版本。如果您的程序应该兼容 jdbc，请使用该方法进行批处理。它可能性能较差（根据 oracle 文档），但您的代码与其他 jdbc 驱动程序兼容。")])]),s._v(" "),a("h3",{attrs:{id:"_5-1-sendbatch的使用示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-sendbatch的使用示例"}},[s._v("#")]),s._v(" 5.1 sendBatch的使用示例")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('OracleDataSource ods = new OracleDataSource();\nods.setURL("jdbc:oracle:oci);\nods.setUser("scott");\nods.setPassword("tiger");\n\nConnection conn = ods.getConnection();\nconn.setAutoCommit(false);\n\nPreparedStatement ps = \n  conn.prepareStatement("insert into dept values (?, ?, ?)"); \n     \n//将此语句的批处理大小更改为 3 \n((OraclePreparedStatement)ps).setExecuteBatch (3);\n \nps.setInt(1, 23); \nps.setString(2, "Sales"); \nps.setString(3, "USA"); \n//JDBC 将此排队以供稍后执行\nps.executeUpdate(); \n \nps.setInt(1, 24); \nps.setString(2, "Blue Sky"); \nps.setString(3, "Montana"); \n//JDBC 将此排队以供稍后执行\nps.executeUpdate(); \n \nps.setInt(1, 25); \nps.setString(2, "Applications"); \nps.setString(3, "India"); \n/队列大小等于批处理值 3， JDBC 将请求发送到数据库\nps.executeUpdate();\n\nps.setInt(1, 26); \nps.setString(2, "HR"); \nps.setString(3, "Mongolia"); \n// JDBC 将此请求排队以供稍后执行\nps.executeUpdate();\n \n// JDBC 发送排队的请求\n((OraclePreparedStatement)ps).sendBatch();\nconn.commit();\n\nps.close();\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br")])]),a("h2",{attrs:{id:"_6-参考文档"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-参考文档"}},[s._v("#")]),s._v(" 6. 参考文档")]),s._v(" "),a("ul",[a("li",[s._v("关于Oracle批处理的参考文档: https://docs.oracle.com/cd/B28359_01/java.111/b31224/oraperf.htm")])])])}),[],!1,null,null,null);n.default=e.exports}}]);